<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta charset="utf-8"/>
        
        <title>URDF_Motion_Control</title>
        <!--Setting the URDF data-->
        <input type="hidden" id="email_data" value="{{shot_datas}}">  <!--value={{color_hex}} of the current model send from the web open link data-->   
        <input type="hidden" id="model_name" value="{{model_files}}"> 
        <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.4.3/webcomponents-bundle.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300" rel="stylesheet"/>
        <link href="../static/styles.css" type="text/css" rel="stylesheet" />
        <script src="../static/src/redirect.js"></script>
        <script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js'></script>
       <!-- <script src="https://cdn.jsdelivr.net/npm/kalmanjs@1.1.0/lib/kalman.min.js" type="text/javascript"></script> -->
        <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.138.0/build/three.module.js",
                "OrbitControls": "https://unpkg.com/three@0.138.0/examples/jsm/controls/OrbitControls.js"
            }
        }
    </script>  
    </head>
    <body tabindex="0">
        
        <div id="menu">
            <ul id="urdf-options">  <!--T12_flipped.URDF--><!--Joint_link_create_1_leg.URDF--> <!--first_generate.URDF-->
                <!--Atlete_robotics.URDF-->
                <!--Need project name and file name of the project inside the urdf -->
                <li urdf="../static/urdf/Atlete_robotics/urdf/{{model_files}}" color="#033843">{{project_names}}</li>  <!--#E91E63 Change the color after the color code -->
                <!--<li urdf="static/urdf/TriATHLETE/urdf/TriATHLETE_flipped.URDF" color="#009688">TriATHLETE</li>-->
                <!--<li urdf="static/urdf/TriATHLETE_Climbing/urdf/TriATHLETE_flipped.URDF" color="#FFB300">TriATHLETE Climbing</li>-->
            </ul>

            <div id="controls" class="hidden">
                <div id="toggle-controls"></div>
                <!--<div>Drag and drop URDF files or folders! <br/> (Chrome Only)</div> -->
                <div id="ignore-joint-limits" class="toggle">Ignore Joint Limits</div>
                <div id="radians-toggle" class="toggle">Use Radians</div>
                <div id="autocenter-toggle" class="toggle checked">Autocenter</div>
                <div id="collision-toggle" class="toggle">Show Collision</div>
                <div id="do-animate" class="toggle checked">Animate Joints</div>
                <label>
                    Up Axis
                    <select id="up-select">
                        <option value="+X">+X</option>
                        <option value="-X">-X</option>
                        <option value="+Y">+Y</option>
                        <option value="-Y">-Y</option>
                        <option value="+Z">+Z</option>
                        <option value="-Z" selected>-Z</option>
                    </select>
                </label>
                <ul></ul>
            </div>
        </div>
        <urdf-viewer up="-Z" display-shadow tabindex="0"></urdf-viewer>

        <!--<script src="static/src/index.js"></script> place the code of javascript to replate index--> 
        <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.js"></script>-->
        <!--<script src="static/src/dragAndDrop.js"></script>-->
        <script type="module" >
         /* globals */
         var gui = new dat.GUI({autoPlace: true}); //Load the gui into th scene 
        var joint_name_mem = {}; 
        var Motor_type_mem = {}; 
        var Communication_mem = {};
        var motor_function = {};
        var joint_function = {};  
        var joint_parameters = {}; 
        var project_include = {};
        var Create_joint_package = {};
        var Joint_type_ref = {};   //Get the joint type data 
        //single board computer 
        var Board_controllers_embed = {};   
        var compo_devices_i2c_control = {} ; 
        var compo_devices_read = {}; 
        var i2c_gpio_pin = {};  //Get the gpio pin data 
        //MCUs microcontroller
        var mcus_lists_pins = {};  
        var mcus_families = {}; 
        var mcus_category = {}; 
        var mcus_number = {}; 
        var mcus_IO_function = {}; 
        var mcus_pack_list  = {};
        var mcus_packages_dat = {}; 
        var computer_Boards = {};
        var request_devices_comport = {};
        var Board_packages = {};   // Get the board package to verify the boards data of the client to pack the information to the write positioning generator 
        var request_port_coms = {};
        var define_hardware = {};  
        var motion_recorder = {}; // Save the motion control to control the robot motion 
        var feedback_sensor = {}; //get the feedback sensor 
        var analog_pin_sensor = {}; //get the analog pin sensor with the position integrated into the system 
        var I2C_reader_pin = {}; //Get the i2c reader pin position this will only working on the single-board computer to access the i2c on the preinstalled sensor library and smbus for a range of single-board computer support 
        var feed_back_status = {}; //Get the i2c reader pin   
        var analog_pin_name = {}; 
        var analog_mcus_pin = {};
        var analog_mcus_pos = {}; 
        var joint_static = {}; 
        var Motion_rec = {};  //The data will be append the value into the dict eh
        var current_mod_select = {}; //Get the current model selection 
   
        //Only work on the server 
        
        fetch('/devices_reporter', {
      
      // Declare what type of data we're sending
      headers: {
        'Content-Type': 'application/json'
      },

      // Specify the method
      method: 'POST',

      // A JSON payload
      body: JSON.stringify({
        "email": String(JSON.parse(atob(document.getElementById('email_data').value))['email'])
      })
    }).then(function (response) { // At this point, Flask has printed our JSON
      return response.text();
    }).then(function (text) {

      console.log('POST response: ');
      // Should be 'OK' if everything was successful
      json_data = JSON.parse(text);

    });
    function downloadJSON(data, filename) {
                         const json = JSON.stringify(data); 
                         const blob = new Blob([json], { type: 'application/json' });
                         const url = URL.createObjectURL(blob);
                         const a = document.createElement('a');
                         a.href = url;
                         a.download = filename || 'data.json';
                         document.body.appendChild(a);
                         a.click();
                         document.body.removeChild(a);
                         URL.revokeObjectURL(url);
    }
        var settings = {
          Project_name: document.getElementById("model_name").value,
          joint_created:"Non_select",
          Start_record:function(){
                      console.log("Start recording motion from angle of 3D model data"); //Get the input data to running in the recorder 
                      alert("Start record joints motion from 3d model")
                      Motion_rec["Start_rec"] = {"Model":[]}  //Get the current model select record        
          },
          Start_sensor_rec:function(){
                     console.log("Start recording motion from the angle of 3D model data");   
                     alert("Start record motion from joints sensor data")
                     Motion_rec["Start_rec"] = {"Sensors":[]}  //Get the  current sensor select record          
          },
          Stop_record:function(){
                     console.log("Stop recording now replacing the list into the string value");
                     alert("Stop recording!")
                     Motion_rec["Start_rec"] = {"Stop_recorder_motion":[]}            
          },
          save_recorder:function(){
                     console.log("Save recorded data")
                     alert("Save recorded data")
                     Motion_rec["Start_rec"] = {"Save_record":[]}                       
          },
          play_recorder:function(){
                     console.log("Play recording running the loop of the recording list into the data ");
                     Motion_rec['Start_rec'] = {"Play_record":[]} //Play the record data from the list of the function 
                                   
          },
          export_motion:function(){
                     console.log("Export recorded motion"); 
                     //export the json file of the recorded motion 
                     var account_payload = document.getElementById('email_data').value
                     var account_Data = JSON.parse(atob(account_payload));
                     var project_name = account_Data["project_name"]
                     downloadJSON(joint_static, project_name+"_motion_recorded.json");                 

          },
          UPload_URDF:function(){
                          //Upload function code of data fetch upload 
                          console.log("Upload edited urdf file") 
 
             
          }
          ,
          joint_post_dat:function(){
                    //Fetch data to backend to send the joint package dat 
                    console.log("Joint generator ",Create_joint_package);
                    fetch('/Create_joint_control', {
                      // Declare what type of data we're sending
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      // Specify the method
                      method: 'POST',
                      // A JSON payload
                      body: JSON.stringify(Create_joint_package)
                      }).then(function (response) { // At this point, Flask has printed our JSON
                      return response.text();
                      }).then(function (text) {
                      console.log('POST response: ');
                          // Should be 'OK' if everything was successful
                          var data_joint_gen = JSON.parse(text);
                          console.log("Joint_gen ",data_joint_gen);
                          alert("Generate joint control on hardware successfully!")     
                      }); 

          },
          joint_hardware_gen:function(){
               
               var board_controller = Board_controllers_embed['Controller_boards_embed'] 
               //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                      //Single board computer 
               if(board_controller == "SBC"){
                 console.log('Generate the joint hardware sync motion control');
                 var profile_data = JSON.parse(atob(document.getElementById('email_data').value))
                 var computerboards = computer_Boards['computer_board'] //Computer onboard nme           
                 var joint_names = joint_name_mem['joint_name']
                 var motor_type_dat  = Motor_type_mem['motor_type']
                 var communication_data = Communication_mem['communication']
                 var i2cDevices = compo_devices_i2c_control['i2c_control'] 
                 var i2cGPIO_pin = i2c_gpio_pin['i2c_GPIO']
                 var I2C_mcus_read_sensor = I2C_reader_pin['read_i2c_dev'] //Get the i2c device pin address    
                 Board_packages[board_controller] = {"SBC":{'communication':communication_data,'i2c_sbc_devices':i2cDevices,'i2c_sbc_pin':i2cGPIO_pin,"Joints_type":Joint_type_ref["Joints_type"]}}                         
                 joint_parameters[joint_names]  = Board_packages['SBC']
                 
                 define_hardware[computerboards] = joint_parameters
                 project_include[Object.keys(profile_payload[profile_data['email']])[0]] = define_hardware
                 Create_joint_package[profile_data['email']] = project_include;     
                 console.log(joint_parameters);
                 console.log(Create_joint_package);
                 console.log(Object.keys(profile_payload[profile_data['email']])[0]);  
                 alert(joint_name_mem['joint_name']+" joint generated")
               }
               //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
               if(board_controller == "MCUs"){
               //MCUs
               console.log('Generate the joint hardware sync motion control');
               var profile_data = JSON.parse(atob(document.getElementById('email_data').value))
               var joint_names = joint_name_mem['joint_name']
               var motor_type_dat  = Motor_type_mem['motor_type']
               var communication_data = Communication_mem['communication']
               var mcus_Families = mcus_families['mcus_families']
               var mcus_Category = mcus_category['mcus_categories']
               var mcus_IO_func  = mcus_IO_function['mcus_IO']
               var mcus_Code     = mcus_number['mcus_codes']
               var mcus_pins_pack = mcus_pack_list['Pins_function']
               var mcus_packages = mcus_packages_dat['Package_list']
               var computerboards = computer_Boards['computer_board'] //Computer onboard nme           
               var communications_port = request_port_coms['Communication_port']   //Communication serial hardware connection or I2C device address to communicate with the board 
               // Feedback status 
               var feed_back_stat = feed_back_status["status_fb"]  // Get the feedback status 
               var feed_back_sensors = feedback_sensor["sensor_feed_back"]
               //Assembly analog pin data input 
               var analog_pins_mcus = analog_pin_sensor['Pin_analog_data']
               var analog_pins_names = analog_pin_name["Pin_names"] 
               //var analog_mcus_pins = analog_mcus_pin["mcus_analog_pins"] 
               //var analog_mcus_poss = analog_mcus_pos["mcus_analog_positions"] 
               console.log(mcus_Families,mcus_Category,mcus_IO_func,mcus_Code,mcus_pins_pack,mcus_packages,computerboards,communications_port); 
               //Add microcontroller part of the components specific data

               Board_packages[board_controller] = {"MCUs":{'motor_type':motor_type_dat,'communication':communication_data,'mcus_families':mcus_Families,'mcus_IO':mcus_IO_func,'mcus_code_number':mcus_Code,'mcus_pins':mcus_pins_pack,'mcus_package':mcus_packages,'Port_address':communications_port,'Joints_type':Joint_type_ref["Joints_type"],'Signal_fbs':feed_back_sensors,'Pin_analog_sensor':analog_pins_mcus}}         
               joint_parameters[joint_names] = Board_packages['MCUs']
               define_hardware[computerboards] = joint_parameters
               project_include[Object.keys(profile_payload[profile_data['email']])[0]] = define_hardware
               Create_joint_package[profile_data['email']] = project_include;     
               console.log(joint_parameters);
               console.log(Create_joint_package);
               console.log(Object.keys(profile_payload[profile_data['email']])[0]);  
               alert(joint_name_mem['joint_name']+" joint generated")
            }               
               //var mcus_datas = mcus_pack_list['Pins_function']    
               //console.log(mcus_Families,mcus_Category,mcus_Code,mcus_Category); 
               //console.log(mcus_Families,mcus_Category,mcus_IO_func,mcus_Code,mcus_pins_pack,mcus_packages,computerboards,communications_port); 
               //joint_parameters[joint_names] = {'motor_type':motor_type_dat,'communication':communication_data,'mcus_families':mcus_Families,'mcus_IO':mcus_IO_func,'mcus_code_number':mcus_Code,'mcus_pins':mcus_pins_pack,'mcus_package':mcus_packages,'Port_address':communications_port}
               //define_hardware[computerboards] = joint_parameters
              
        }
        
        }    
        gui.add(settings, 'Project_name').name('Project_file').onChange(function(values){
                 console.log("Project_name",values); 
        });
        //var upload_urdf = gui.addFolder("Upload_URDF");  ///Get the urdf model 
        //upload_urdf.add(settings,"UPload_URDF").name('upload_urdf');  //Upload  
        //upload_urdf.open(); //Upload the urdf model function
        var computer_onboard = gui.addFolder("Computer on-board")
        settings['Computer_onboards'] = 'Non-select'; 
        console.log(settings); 
        computer_onboard.open();  // Open the folder 
        fetch('/Computer_board_connected', {
                        // Declare what type of data we're sending
                        headers: {
                             'Content-Type': 'application/json'
                        },
                        // Specify the method
                        method: 'POST',
                        // A JSON payload
                        body: JSON.stringify({
                                   "email": JSON.parse(atob(document.getElementById('email_data').value))['email']
                        })
                        }).then(function (response) { // At this point, Flask has printed our JSON
                        return response.text();
                        }).then(function (text) {
                        console.log('POST response: ');
                        // Should be 'OK' if everything was successful
        var data_boards = JSON.parse(text);
        var compute_host = Object.keys(data_boards)
        compute_host.unshift("Non-select"); 
        var computer_onboards = computer_onboard.add(settings,'Computer_onboards',compute_host).name("Host_name")
        computer_onboards.setValue('Non-select')
        computer_onboards.onChange(function(values_comboard){
            computer_Boards['computer_board'] = values_comboard;
            console.log(computer_Boards); 
        })
    });
        var Joint_hardware = gui.addFolder("Create joint hardware sync")
        //Fetch the data from the back end request to get all the joint from the current project data
        
        function Joint_type_motor_control(Joint_hardware,Joint_name,joint_types){
                  var joint_type_listed = {'revolute':['DC_motor','Stepper_motor','BLDC_motor'],'continuous':['DC_motor','Stepper_motor'],'prismatic':['DC_motor','Stepper_motor','BLDC_motor']}
                  var motor_communication = {'DC_motor':['Serial','I2C','SPI'],'Stepper_motor':['I2C','Serial','UART'],'BLDC_motor':['I2C','Serial','UART']} // Fetch the request data from the list                                    
                  var motor_mcus = {'Serial':{'MCU':{'STM32':[]}}}
                  var list_of_control = joint_type_listed[joint_types]; 
                  console.log(Joint_name,joint_types,list_of_control) 
                  //var HY_1 = Joint_hardware.addFolder(Joint_name);
                  settings[Joint_name+"_list"] = 'Non-select'; 
                  console.log(settings); 
                  settings[Joint_name+"_communication"] = 'Non-select'; 
                  console.log(settings);
                  settings[Joint_name+"_mcus"] = 'Non-select'; 
                  console.log(settings);
                  settings[Joint_name+"_mcus_category"] = 'Non-select'; 
                  console.log(settings);
                  settings[Joint_name+"_mcus_board"] = 'Non-select'; 
                  console.log(settings);
                  settings[Joint_name+"_mcus_IO"] = 'Non-select'; 
                  console.log(settings);
                  settings[Joint_name+"_mcus_pins"] = 'Non-select'; 
                  console.log(settings);
                  settings[Joint_name+"_mcus_pack"] = 'Non-select'; 
                  console.log(settings); 
                  settings[Joint_name+"_request_devices"] = 'Non-select' 
                  console.log(settings); 
                  
                  //Fetch the local mcus from the list of the data in the local server 
                  fetch('/mcus_list_container', {
                    // Declare what type of data we're sending
                    headers: {
                          'Content-Type': 'application/json'
                    },
                    // Specify the method
                    method: 'POST',
                    // A JSON payload
                    body: JSON.stringify({
                           "mcus_request": "request_mcus_parts"
                    })
                   }).then(function (response) { // At this point, Flask has printed our JSON
                   return response.text();
                   }).then(function (text) {
                  console.log('POST response: ');
                  var json_mcus = JSON.parse(text); 
                  var packages = 0; 
                  //for(packages >=0; packages <= json_mcus['mcus_parts'].length; packages++){              
                  motor_mcus['Serial']['MCU']['STM32'] = ( json_mcus['STM32']) 
                  //motor_mcus['Analog']['MCU']['STM32'] = ( json_mcus['STM32']) 
                  console.log("Loaded_mcus control servo   ",motor_mcus); //Load microcontroller into the server 
                  //console.log("Load_mcus Analog pwm ", motor_mcus);

                  //}
                }); 
                  //Fetch MCUS End-here 
                  /*
                  eval("var "+String(Joint_name)+" = Joint_hardware.addFolder('"+String(Joint_name)+"');"+
                  "\n"
                  +String(Joint_name)+".add(settings,'"+Joint_name+"_list"+"',"+list_of_control+").name('"+Joint_name+"_"+joint_types+"')");
                  */
                  joint_name_mem['joint_name'] = Joint_name; 
                  var actuator_select = Joint_hardware.addFolder(Joint_name+"_select_actuator");
                  list_of_control.unshift('Non-select')                      
                  var control_actuator = actuator_select.add(settings,Joint_name+"_list",list_of_control).name(Joint_name+"_"+joint_types)
                  
                  control_actuator.setValue('Non-select'); 
                  control_actuator.onChange(function(values){
                             console.log("Motor values ",values)
                             Motor_type_mem['motor_type'] = values;
                             var commu_dev = motor_communication[values]
                             commu_dev.unshift("Non-select"); 
                             var joint_communication = actuator_select.add(settings,Joint_name+"_communication",commu_dev).name(Joint_name+'_communication').onChange(function(values_com){
                                             console.log("Get_communication_system",values_com); 
                                             Communication_mem['communication'] = values_com; 
                                             //Feth the serial USB here from the selected communication type data 
                                             var com_dict = {"I2C":'i2c_devices','Serial':'serial_devices'}
                                             fetch('/mcus_serial_port', {

                                              // Declare what type of data we're sending
                                              headers: {
                                                  'Content-Type': 'application/json'
                                              },
                                              // Specify the method
                                              method: 'POST', 
                                              // A JSON payload 
                                              body: JSON.stringify({
                                                    "email":JSON.parse(atob(document.getElementById('email_data').value))['email'],'Computer_name':computer_Boards['computer_board'],'communication':com_dict[values_com]
                                              })
                                              }).then(function (response) { // At this point, Flask has printed our JSON
                                              return response.text();
                                              }).then(function (text) {
                                              console.log('POST response: ');
                                                            //Should be 'OK' if everything was successful 
                                                            var communication_data = JSON.parse(text);   //Append the data communication requested add into the list of the json 
                                                            console.log("Communication_Selected from list ",communication_data); // Show the serial or communication port selected that request from the real hardware devices 
                                                            request_devices_comport['com_port_devices'] = communication_data; 
                                                            console.log(request_devices_comport); 

                                             });
                                             //get the  mcus or single board computer i2c selection 
                                             settings[Joint_name+"_board"] = "Non-select"; 
                                             var Board_type = ["SBC","MCUs"]
                                             Board_type.unshift("Non-select"); 
                                             var board_controller = actuator_select.add(settings,Joint_name+"_board",Board_type).name("Select_board")
                                             //board_controller.setValue("Non-select")
                                             board_controller.onChange(function(value_boards){
                                             console.log("Board select",value_boards);   
                                             Board_controllers_embed['Controller_boards_embed'] = value_boards; //Get the value board data for the controller
                                             
                                             if(value_boards == "MCUs"){
                                               if(Communication_mem['communication'] == "Serial"){
                                             var mcus_data_parts = actuator_select.add(settings,Joint_name+"_mcus",Object.keys(motor_mcus['Serial']['MCU'])).name('MCUs_family')
                                             mcus_data_parts.setValue('Non-select')
                                             Object.keys(motor_mcus['Serial']['MCU']).unshift('Non-select'); 
                                             mcus_data_parts.onChange(function(values_mcus){
                                                      console.log("Microcrocontroller ",values_mcus)
                                                      mcus_families['mcus_families'] = values_mcus;
                                                      //Seelect tge mcus category data 
                                                      var list_mcus_data_c =  motor_mcus['Serial']['MCU'][values_mcus]
                                                      var list_mcus_category = Object.keys(motor_mcus['Serial']['MCU'][values_mcus])
                                                      console.log(list_mcus_category);     
                                                      var mcus_data_parts = actuator_select.add(settings,Joint_name+"_mcus_category",list_mcus_category).name("MCUs_category")
                                                      mcus_data_parts.setValue('Non-select')
                                                      mcus_data_parts.onChange(function(values_category){
                                                                    console.log("MCUs_category ",values_category);
                                                                    mcus_category['mcus_categories'] = values_category; 
                                                                    var board_list = list_mcus_data_c[values_category]
                                                                    var mcus_code = actuator_select.add(settings,Joint_name+"_mcus_board",board_list).name("MCUs_number")
                                                                    mcus_code.setValue("Non-select")
                                                                    mcus_code.onChange(function(value_mcus_code){
                                                                        console.log("MCUs_code ",value_mcus_code);
                                                                        mcus_number['mcus_codes'] = value_mcus_code; 
                    
                                                                        var IO_list = ['Servo_PWM_output','PWM_output','Digital_output','I2C_control'] 
                                                                        var mcus_IO  = actuator_select.add(settings,Joint_name+"_mcus_IO",IO_list).name("I/O")
                                                                        mcus_IO.setValue('Non-select')
                                                                        IO_list.unshift('Non-select'); 
                                                                        mcus_IO.onChange(function(IO_values){
                                                                                           console.log(IO_values);
                                                                                           mcus_IO_function['mcus_IO'] = IO_values;                                                                                              //alert("I/O select ",IO_values);
                                                                                           //Fetch the pin of the microcontroller from the back end 
                                                                                           var packages_list = ['Hx', 'Tx', 'Yx', 'Ix', 'Jx', 'TxQ', 'Ux', 'TxA', 'Px', 'Kx', 'Sx', 'HxA', 'HxQ', 'UxN', 'TxN', 'Mx', 'IxQ', 'UxA', 'YxP', 'KxQ']
                                                                                           var pack_mcus_list = actuator_select.add(settings,Joint_name+"_mcus_pack",packages_list).name("Packages")
                                                                                           pack_mcus_list.setValue('Non-select'); 
                                                                                           pack_mcus_list.onChange(function(values_package){
                                                                                                      console.log("Package_list ",values_package);
                                                                                                      mcus_packages_dat['Package_list'] = values_package; 
                    
                                                                                            
                                                                                           fetch('/mcus_pin_data', {
                                                                                                  // Declare what type of data we're sending
                                                                                                  headers: {
                                                                                                           'Content-Type': 'application/json'
                                                                                                  },
                                                                                                  // Specify the method
                                                                                                  method: 'POST',
                                                                                                  // A JSON payload
                                                                                                  body: JSON.stringify({
                                                                                                  "email": JSON.parse(atob(document.getElementById('email_data').value)),'mcus':value_mcus_code,'packages_mcus':values_package
                                                                                           })
                                                                                           }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                           return response.text();
                                                                                           }).then(function (text) {
                                                                                           console.log('POST response: ');
                                                                                           // Should be 'OK' if everything was successful
                                                                                                    var mcus_pin_list_dat = JSON.parse(text); 
                                                                                                    console.log(mcus_pin_list_dat); //       
                                                                                                    var list_pins = mcus_pin_list_dat['mcus_code']
                                                                                                    console.log(list_pins[0]);
                                                                                                    var data_mcus = [list_pins];
                                                                                                    var pr =0; 
                                                                                                    for(pr >=0;pr<=list_pins.length-1;pr++){
                                                                                                                console.log(list_pins[pr]['@Name']);                  
                                                                                                                mcus_lists_pins[list_pins[pr]['@Name']]  = {'@Poisiton':list_pins[pr]['@Position'],'@Type':list_pins[pr]['@Type']}                              
                                                                                                    
                                                                                                    } 
                                                                                                    console.log(mcus_lists_pins);     
                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                 //Classify the motor type and control data                 

                                                                                                    var io_category = mcus_IO_function['mcus_IO']   //Get the io data to classify the type of the control function and motor 
                                                                                                    var motor_type_category = Motor_type_mem['motor_type'] // Get the motor type category 
                                                                                                    
                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                            //Servo_PWM_output
                                                                                                        
                                                                                                 if(io_category == "Servo_PWM_output"){
                                                                                                    if(motor_type_category == "DC_motor"){                          
                                                                                                    Joint_name+"_mcus_pins"
                                                                                                    var mcus_pins = actuator_select.add(settings,Joint_name+"_mcus_pins",Object.keys(mcus_lists_pins)).name('Pins')
                                                                                                    mcus_pins.setValue('Non-select'); 
                                                                                                    mcus_pins.onChange(function(values_pins){
                                                                                                                console.log("Pins_function ",values_pins,mcus_lists_pins[values_pins]); 
                                                                                                                
                                                                                                                mcus_pack_list['Pins_function'] = {'pin_name':values_pins,'pin_pos_type':mcus_lists_pins[values_pins]}; //Check the pins list                              
                                                                                                                
                                                                                                                var port_com =  Communication_mem['communication']
                                                                                                                var internalcom =  request_devices_comport['com_port_devices']
                                                                                                                console.log("Data_communication_com ",internalcom); 
                                                                                                                //Check if pin is exist in the map 
                                                                                                                //console.log("STM32_mcus_list ",motor_mcus['Serial']['MCU']['STM32']);                                                                           
                                                                                                                fetch('/mcus_pin_map_data', {

                                                                                                                    // Declare what type of data we're sending
                                                                                                                    headers: {
                                                                                                                            'Content-Type': 'application/json'
                                                                                                                    },
                                                                                                                    // Specify the method
                                                                                                                    method: 'POST',
                                                                                                                    // A JSON payload
                                                                                                                    body: JSON.stringify({
                                                                                                                      "Data_map": "pin_map_mcus"
                                                                                                                })
                                                                                                                }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                                                return response.text();
                                                                                                                }).then(function (text) {
                                                                                                                console.log('POST response: ');
                                                                                                                         // Should be 'OK' if everything was successful
                                                                                                                         //console.log(text);  
                                                                                                                         var mcus_pin_map = JSON.parse(text);
                                                                                                                         var fam_mcus = mcus_families['mcus_families'] 
                                                                                                                         var mcus_codes_num = mcus_number['mcus_codes'] 
                                                                                                                         var mcus_package =   mcus_packages_dat['Package_list']
                                                                                                                         var mcus_num_codes = mcus_codes_num+mcus_package   
                                                                                                                         console.log("Mcus_code_number ",mcus_num_codes);  
                                                                                                                         console.log(mcus_pin_map[fam_mcus][mcus_num_codes]);  //Get all the list of the pin map 
                                                                                                                         var list_pins_map = Object.keys(mcus_pin_map[fam_mcus][mcus_num_codes]); 
                                                                                                                         console.log("Pins_map_list ",list_pins_map);  
                                                                                                                         if(list_pins_map.includes(values_pins) == true){
                                                                                                                                     console.log("Mcus_firmware_pins ",mcus_pin_map[fam_mcus][mcus_num_codes][values_pins]); 
                                                                                                                                     if(port_com == 'Serial'){
                                                                                                                
                                                                                                                                             var Serial_port = Object.keys(request_devices_comport['com_port_devices']); 
                                                                                                                                             Serial_port.unshift('Non-select');
                                                                                                                                             var serial_devices_port = actuator_select.add(settings,Joint_name+"_request_devices",Serial_port).name('Port')
                                                                                                                                             serial_devices_port.setValue('Non-select') 
                                                                                                                                             serial_devices_port.onChange(function(values_serial_port){
                                                                                                                                                     console.log("Serial port data",values_serial_port);
                                                                                                                                                     request_port_coms['Communication_port']   = values_serial_port  //Get the serial port data of the microcontroller                                        
                                                                                                                                      });
                                                                                                                                      //Fetch the analog sensor data here into the list
                                                                                                                                      var data_container = {"Mcus_familiy": mcus_families['mcus_families'] ,"Mcus_name": mcus_num_codes} 
                                                                                                                                      console.log("Data_containner ",data_container); 
                                                                                                                                                                                                                                                                                         
                                                                                                                                                               // POST
                                                                                                                                                               settings["feedback_sensor"] = false;  // Set the feedback sensor as default   
                                                                                                                                                               //feed_back_status["status_fb"] = false; // checking the false status of the feedback sensor status  
                                                                                                                                                               var feed_back_status = actuator_select.add(settings,"feedback_sensor").name("Select feedback sensor")
                                                                                                                                                               feed_back_status.setValue(false);
                                                                                                                                                               feed_back_status.onChange(function(values_feed_back){
                                                                                                                                                                              console.log("Feed back sensor status ",values_feed_back); //Get the feedback sensor settings     
                                                                                                                                                                              if(values_feed_back == true){
                                                                                                                                                                                          console.log("Activate sensor feedback selection"); 
                                                                                                                                                                                          //feed_back_status["status_fb"] = true; //Get the feedback status of the function                                               
                                                                                                                                                                                          
                                                                                                                                                                                          settings["feedback_sensor"] = "Non-select"; 
                                                                                                                                                                                                    
                                                                                                                                                                                                    var Feed_back_sensor_list = ["Analog-read","UART"];  
                                                                                                                                                                                                    Feed_back_sensor_list.unshift("Non-select"); 
                                                                                                                                                                                                    var sensor_feedback = actuator_select.add(settings,"feedback_sensor",Feed_back_sensor_list).name("Feedback_sensor") 
                                                                                                                                                                                                    sensor_feedback.setValue("Non-select"); 
                                                                                                                                                                                                    sensor_feedback.onChange(function(values_sensors){
                                                                                                                                                                                                                        console.log("Sensor feedback in ",values_sensors); //Get the sensor feedback data 
                                                                                                                                                                                                                        
                                                                                                                                                                                        if(values_sensors == "Analog-read"){
                                                                                                                                                                                               feedback_sensor["sensor_feed_back"] = values_sensors; //Sensor 
                                                                                                                                                                                               fetch('/Mcus_analog_read', {

                                                                                                                                                                                                    // Declare what type of data we're sending 
                                                                                                                                                                                                    headers: {
                                                                                                                                                                                                             'Content-Type': 'application/json'
                                                                                                                                                                                                    },

                                                                                                                                                                                                    // Specify the method
                                                                                                                                                                                                    method: 'POST',

                                                                                                                                                                                                    // A JSON payload
                                                                                                                                                                                                    body: JSON.stringify({
                                                                                                                                                                                                        
                                                                                                                                                                                                    "Mcus_familiy": mcus_families['mcus_families'] ,"Mcus_name": mcus_num_codes
                                                                                                                                                                                                    
                                                                                                                                                                                                })
                                                                                                                                                                                                    }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                                                                                                                                    return response.text(); 
                                                                                                                                                                                                    }).then(function (text) {
                                                                                                                                                                                                    console.log('POST response: ');
                                                                                                                                                                                                    // Should be 'OK' if everything was successful
                                                                                                                                                                                                    var analog_pin_list = JSON.parse(text); 
                                                                                                                                                                                                    
                                                                                                                                                                                                    console.log("List analog pin ",analog_pin_list); 
                                                                                                                                                                                                    settings["analog_fb"] = "Non-select"; 
                                                                                                                                                                                                    var analog_chip_name  = Object.keys(analog_pin_list); // Get the chip name data 
                                                                                                                                                                                                    analog_chip_name.unshift("Non-select");   
                                                                                                                                                                                                    var analog_read_fb = actuator_select.add(settings,"analog_fb",analog_chip_name).name(Joint_name+"_Analog-read")
                                                                                                                                                                                                    analog_read_fb.setValue("Non-select"); 
                                                                                                                                                                                                    analog_read_fb.onChange(function(values_analogs){

                                                                                                                                                                                                             console.log("Selected analog pin ",values_analogs,analog_pin_list[values_analogs],mcus_lists_pins[values_analogs]); // Also get the position of the analog pin mapping into the system                                                                         
                                                                                                                                                                                                             analog_pin_name["Pin_names"]  = values_analogs; 
                                                                                                                                                                                                             analog_pin_sensor["Pin_analog_data"] = {"Pin_name":analog_pin_name['Pin_names'],"mcus_analog_pin":analog_pin_list[values_analogs],"mcus_analog_position":mcus_lists_pins[values_analogs]}; // Also get the position of the analog pin mapping into the system                                                                        
                                                                                                                                                                                                                                         
                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                })
                                                                                                                                                                                           }
                                                                                                                                                                                           

                                                                                                                                                                                   });
                                                                                                                                                                              }
                                                                                                                                                               })                                                                                                                                                        
                                                                                                                                                                 
                                                                                                                                                                                
                                                                                                                                                                
                                                                                                                                    }  
                                                                                                                                      if(port_com == 'I2C'){
                                                                                                                
                                                                                                                                                var Address_port = Object.values(request_devices_comport['com_port_devices']); 
                                                                                                                                                Address_port.unshift('Non-select');
                                                                                                                                                var address_devices = actuator_select.add(settings,Joint_name+"_request_devices",Address_port).name('Address')
                                                                                                                                                address_devices.setValue('Non-select') 
                                                                                                                                                address_devices.onChange(function(values_address){
                                                                                                                                                         console.log("Address data",values_address);   
                                                                                                                                                         request_port_coms['Communication_port'] = values_address;  //Servo I2C or I2C serial hardware control devices 

                                                                                                                                     });

                                                                                                                                    } 

                                                                                                                                       actuator_select.add(settings,'joint_hardware_gen').name(Joint_name+"_add_joint") 
                                                                                                                        }
                                                                                                                        if(list_pins_map.includes(values_pins) == false){
                                                                                                                                    
                                                                                                                                        alert("This pin is not in the list of the standard firmata pin map");     
                                                                                                                        }
                                                                                                                });

                                                                                                                


 
                                                                                                    });
                                                                                                     }
                                                                                                                                                    //End checking the data of the pin pin function as Servo_PWM_output
                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                }                
                                                                                                //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                    //PWM_output                                      
                                                                                                if(io_category == "PWM_output"){
                                                                                                    if(motor_type_category == "DC_motor"){    

                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                            // Pin_1 pwm  motor                            
                                                                                                    var pin_pwm_out = {};
                                                                                                    Joint_name+"_mcus_pins"
                                                                                                    var mcus_pins = actuator_select.add(settings,Joint_name+"_mcus_pins",Object.keys(mcus_lists_pins)).name('Pins_L')
                                                                                                    mcus_pins.setValue('Non-select'); 
                                                                                                    mcus_pins.onChange(function(values_pins){
                                                                                                                console.log("Pins_function ",values_pins,mcus_lists_pins[values_pins]);
                                                                                                                pin_pwm_out['Pin_L'] = {'pin_name':values_pins,'pin_pos_type':mcus_lists_pins[values_pins]}; 
                                                                                                                mcus_pack_list['Pins_function'] = pin_pwm_out;    
                                                                                                                var port_com =  Communication_mem['communication']
                                                                                                                var internalcom =  request_devices_comport['com_port_devices']
                                                                                                                console.log("Data_communication_com ",internalcom); 
                                                                                                                //Check if pin is exist in the map 
                                                                                                                //console.log("STM32_mcus_list ",motor_mcus['Serial']['MCU']['STM32']);                                                                           
                                                                                                                fetch('/mcus_pin_map_data', {

                                                                                                                    // Declare what type of data we're sending
                                                                                                                    headers: {
                                                                                                                            'Content-Type': 'application/json'
                                                                                                                    },
                                                                                                                    // Specify the method
                                                                                                                    method: 'POST',
                                                                                                                    // A JSON payload
                                                                                                                    body: JSON.stringify({
                                                                                                                      "Data_map": "pin_map_mcus"
                                                                                                                })
                                                                                                                }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                                                return response.text();
                                                                                                                }).then(function (text) {
                                                                                                                console.log('POST response: ');
                                                                                                                         // Should be 'OK' if everything was successful
                                                                                                                         //console.log(text);  
                                                                                                                         var mcus_pin_map = JSON.parse(text);
                                                                                                                         var fam_mcus = mcus_families['mcus_families'] 
                                                                                                                         var mcus_codes_num = mcus_number['mcus_codes'] 
                                                                                                                         var mcus_package =   mcus_packages_dat['Package_list']
                                                                                                                         var mcus_num_codes = mcus_codes_num+mcus_package   
                                                                                                                         console.log("Mcus_code_number ",mcus_num_codes);  
                                                                                                                         console.log(mcus_pin_map[fam_mcus][mcus_num_codes]);  //Get all the list of the pin map 
                                                                                                                         var list_pins_map = Object.keys(mcus_pin_map[fam_mcus][mcus_num_codes]); 
                                                                                                                         console.log("Pins_map_list ",list_pins_map);  
                                                                                                                         if(list_pins_map.includes(values_pins) == true){
                                                                                                                                     console.log("Mcus_firmware_pins ",mcus_pin_map[fam_mcus][mcus_num_codes][values_pins]); 
                                                                                                                                               
                                                                                                                        }
                                                                                                                        if(list_pins_map.includes(values_pins) == false){
                                                                                                                                    
                                                                                                                                        alert("This pin is not in the list of the standard firmata pin map");     
                                                                                                                        }
                                                                                                                });

                                                                                                                


 
                                                                                                    });
                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                     //Pin 2 output pwm  
                                                                                                    Joint_name+"_mcus_pins"
                                                                                                    var mcus_pins = actuator_select.add(settings,Joint_name+"_mcus_pins",Object.keys(mcus_lists_pins)).name('Pins_R')
                                                                                                    mcus_pins.setValue('Non-select'); 
                                                                                                    mcus_pins.onChange(function(values_pins){
                                                                                                                console.log("Pins_function ",values_pins,mcus_lists_pins[values_pins]); 
                                                                                                                pin_pwm_out['Pin_R'] = {'pin_name':values_pins,'pin_pos_type':mcus_lists_pins[values_pins]}; 
                                                                                                                mcus_pack_list['Pins_function'] = pin_pwm_out;
                                                                                                                var port_com =  Communication_mem['communication']
                                                                                                                var internalcom =  request_devices_comport['com_port_devices']
                                                                                                                console.log("Data_communication_com ",internalcom); 
                                                                                                                //Check if pin is exist in the map 
                                                                                                                //console.log("STM32_mcus_list ",motor_mcus['Serial']['MCU']['STM32']);                                                                           
                                                                                                                fetch('/mcus_pin_map_data', {

                                                                                                                    // Declare what type of data we're sending
                                                                                                                    headers: {
                                                                                                                            'Content-Type': 'application/json'
                                                                                                                    },
                                                                                                                    // Specify the method
                                                                                                                    method: 'POST',
                                                                                                                    // A JSON payload
                                                                                                                    body: JSON.stringify({
                                                                                                                      "Data_map": "pin_map_mcus"
                                                                                                                })
                                                                                                                }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                                                return response.text();
                                                                                                                }).then(function (text) {
                                                                                                                console.log('POST response: ');
                                                                                                                         // Should be 'OK' if everything was successful
                                                                                                                         //console.log(text);  
                                                                                                                         var mcus_pin_map = JSON.parse(text);
                                                                                                                         var fam_mcus = mcus_families['mcus_families'] 
                                                                                                                         var mcus_codes_num = mcus_number['mcus_codes'] 
                                                                                                                         var mcus_package =   mcus_packages_dat['Package_list']
                                                                                                                         var mcus_num_codes = mcus_codes_num+mcus_package   
                                                                                                                         console.log("Mcus_code_number ",mcus_num_codes);  
                                                                                                                         console.log(mcus_pin_map[fam_mcus][mcus_num_codes]);  //Get all the list of the pin map 
                                                                                                                         var list_pins_map = Object.keys(mcus_pin_map[fam_mcus][mcus_num_codes]); 
                                                                                                                         console.log("Pins_map_list ",list_pins_map);  
                                                                                                                         if(list_pins_map.includes(values_pins) == true){
                                                                                                                                     console.log("Mcus_firmware_pins ",mcus_pin_map[fam_mcus][mcus_num_codes][values_pins]); 
                                                                                                                                     if(port_com == 'Serial'){
                                                                                                                
                                                                                                                                             var Serial_port = Object.keys(request_devices_comport['com_port_devices']); 
                                                                                                                                             Serial_port.unshift('Non-select');
                                                                                                                                             var serial_devices_port = actuator_select.add(settings,Joint_name+"_request_devices",Serial_port).name('Port')
                                                                                                                                             serial_devices_port.setValue('Non-select') 
                                                                                                                                             serial_devices_port.onChange(function(values_serial_port){
                                                                                                                                                     console.log("Serial port data",values_serial_port);
                                                                                                                                                     request_port_coms['Communication_port']   = values_serial_port  //Get the serial port data of the microcontroller                                        
                                                                                                                                      });    
                                                                                                                                      settings["feedback_sensor"] = false;  // Set the feedback sensor as default   
                                                                                                                                                               var feed_back_status = actuator_select.add(settings,"feedback_sensor").name("Select feedback sensor")
                                                                                                                                                               feed_back_status.onChange(function(values_feed_back){
                                                                                                                                                                              console.log("Feed back sensor status ",values_feed_back); //Get the feedback sensor settings     
                                                                                                                                                                              if(values_feed_back == true){
                                                                                                                                                                                          console.log("Activate sensor feedback selection"); 

                                                                                                                                                                                          settings["feedback_sensor"] = "Non-select"; 
                                                                                                                                                                                                    
                                                                                                                                                                                                    var Feed_back_sensor_list = ["Analog-read","UART"];  
                                                                                                                                                                                                    Feed_back_sensor_list.unshift("Non-select"); 
                                                                                                                                                                                                    var sensor_feedback = actuator_select.add(settings,"feedback_sensor",Feed_back_sensor_list).name("Feedback_sensor") 
                                                                                                                                                                                                    sensor_feedback.setValue("Non-select"); 
                                                                                                                                                                                                    sensor_feedback.onChange(function(values_sensors){
                                                                                                                                                                                                                        console.log("Sensor feedback in ",values_sensors); //Get the sensor feedback data 
                                                                                                                                                                                                                        
                                                                                                                                                                                        if(values_sensors == "Analog-read"){
                                                                                                                                                                                               feedback_sensor["sensor_feed_back"] = values_sensors; //Sensor 
                                                                                                                                                                                               fetch('/Mcus_analog_read', {

                                                                                                                                                                                                    // Declare what type of data we're sending 
                                                                                                                                                                                                    headers: {
                                                                                                                                                                                                             'Content-Type': 'application/json'
                                                                                                                                                                                                    },

                                                                                                                                                                                                    // Specify the method
                                                                                                                                                                                                    method: 'POST',

                                                                                                                                                                                                    // A JSON payload
                                                                                                                                                                                                    body: JSON.stringify({
                                                                                                                                                                                                    "Mcus_familiy": mcus_families['mcus_families'] ,"Mcus_name": mcus_num_codes
                                                                                                                                                                                                    })
                                                                                                                                                                                                    }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                                                                                                                                    return response.text(); 
                                                                                                                                                                                                    }).then(function (text) {
                                                                                                                                                                                                    console.log('POST response: ');
                                                                                                                                                                                                    // Should be 'OK' if everything was successful
                                                                                                                                                                                                    var analog_pin_list = JSON.parse(text); 
                                                                                                                                                                                                    
                                                                                                                                                                                                    console.log("List analog pin ",analog_pin_list); 
                                                                                                                                                                                                    settings["analog_fb"] = "Non-select"; 
                                                                                                                                                                                                    var analog_chip_name  = Object.keys(analog_pin_list); // Get the chip name data 
                                                                                                                                                                                                    analog_chip_name.unshift("Non-select");   
                                                                                                                                                                                                    var analog_read_fb = actuator_select.add(settings,"analog_fb",analog_chip_name).name(Joint_name+"_Analog-read")
                                                                                                                                                                                                    analog_read_fb.setValue("Non-select"); 
                                                                                                                                                                                                    analog_read_fb.onChange(function(values_analogs){

                                                                                                                                                                                                             console.log("Selected analog pin ",values_analogs,analog_pin_list[values_analogs],mcus_lists_pins[values_analogs]); // Also get the position of the analog pin mapping into the system                                                                        
                                                                                                                                                                                                             analog_pin_sensor["Pin_analog_data"] = {"Pin_name":values_analogs,"mcus_analog_pin":analog_pin_list[values_analogs],"mcus_analog_position":mcus_lists_pins[values_analogs]}; // Also get the position of the analog pin mapping into the system                                                                        
                                                                                                                                                                                                                                         
                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                })
                                                                                                                                                                                           }
                                                                                                                                                                                           

                                                                                                                                                                                   });
                                                                                                                                                                              }
                                                                                                                                                               })                                                                                                                                                        
                                                                                                                                                                 
                                                                                                                                                                                                
                                                                                                                                      }  
                                                                                                                                      if(port_com == 'I2C'){
                                                                                                                
                                                                                                                                                var Address_port = Object.values(request_devices_comport['com_port_devices']); 
                                                                                                                                                Address_port.unshift('Non-select');
                                                                                                                                                var address_devices = actuator_select.add(settings,Joint_name+"_request_devices",Address_port).name('Address')
                                                                                                                                                address_devices.setValue('Non-select') 
                                                                                                                                                address_devices.onChange(function(values_address){
                                                                                                                                                         console.log("Address data",values_address);   
                                                                                                                                                         request_port_coms['Communication_port'] = values_address;  //Servo I2C or I2C serial hardware control devices 

                                                                                                                                     });                    
                                                                                                                                    } 

                                                                                                                                       actuator_select.add(settings,'joint_hardware_gen').name(Joint_name+"_add_joint") 
                                                                                                                        }
                                                                                                                        if(list_pins_map.includes(values_pins) == false){
                                                                                                                                    
                                                                                                                                        alert("This pin is not in the list of the standard firmata pin map");     
                                                                                                                        }
                                                                                                                });

                                                                                                                


 
                                                                                                    });
                                                                                                                                     


                                                                                                     }
                                                                                                                                                    //End checking the data of the pin pin function as PWM_output
                                                                                                     //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                                                           

                                                                                                } 
                                                                                               
                                                                                           });
                                                                                                    
                                                                                           //actuator_select.add(settings,'joint_hardware_gen').name(Joint_name+"_add_joint")

                                                                                        })    
                                                                                            // Add joint control function to control the real servo motor
                                                                                           
                                                                        });         
                                                                    });
                                                                    //Addjoint after category selected

                                                                       
                                                      });     
                                                      //actuator_select.add(settings,'joint_hardware_gen').name(Joint_name+"_add_joint") // Add joint control function to control the real servo motor 
                                                                   
                                       })
                                      }
                                    // End of the microcontroller part selection function here    
                                    }        
                                   //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>..
                                                                                       //I2C single board computer function here 
                                    if(value_boards == "SBC"){

                                            if (Communication_mem['communication'] == "Serial"){
                                                 alert("UART will update soon!");    
                                                
                                                
                                                 /*
                                                       console.log("Serial UART selection of the single-board")
                                                       var mcus_data_parts = actuator_select.add(settings,Joint_name+"_mcus",Object.keys(motor_mcus['Serial']['MCU'])).name('MCUs_family')
                                             mcus_data_parts.setValue('Non-select')
                                             Object.keys(motor_mcus['Serial']['MCU']).unshift('Non-select'); 
                                             mcus_data_parts.onChange(function(values_mcus){
                                                      console.log("Microcrocontroller ",values_mcus)
                                                      mcus_families['mcus_families'] = values_mcus;
                                                      //Seelect tge mcus category data 
                                                      var list_mcus_data_c =  motor_mcus['Serial']['MCU'][values_mcus]
                                                      var list_mcus_category = Object.keys(motor_mcus['Serial']['MCU'][values_mcus])
                                                      console.log(list_mcus_category);     
                                                      var mcus_data_parts = actuator_select.add(settings,Joint_name+"_mcus_category",list_mcus_category).name("MCUs_category")
                                                      mcus_data_parts.setValue('Non-select')
                                                      mcus_data_parts.onChange(function(values_category){
                                                                    console.log("MCUs_category ",values_category);
                                                                    mcus_category['mcus_categories'] = values_category; 
                                                                    var board_list = list_mcus_data_c[values_category]
                                                                    var mcus_code = actuator_select.add(settings,Joint_name+"_mcus_board",board_list).name("MCUs_number")
                                                                    mcus_code.setValue("Non-select")
                                                                    mcus_code.onChange(function(value_mcus_code){
                                                                        console.log("MCUs_code ",value_mcus_code);
                                                                        mcus_number['mcus_codes'] = value_mcus_code; 
                    
                                                                        var IO_list = ['Servo_PWM_output','PWM_output','Digital_output','I2C_control'] 
                                                                        var mcus_IO  = actuator_select.add(settings,Joint_name+"_mcus_IO",IO_list).name("I/O")
                                                                        mcus_IO.setValue('Non-select')
                                                                        IO_list.unshift('Non-select'); 
                                                                        mcus_IO.onChange(function(IO_values){
                                                                                           console.log(IO_values);
                                                                                           mcus_IO_function['mcus_IO'] = IO_values;                                                                                              //alert("I/O select ",IO_values);
                                                                                           //Fetch the pin of the microcontroller from the back end 
                                                                                           var packages_list = ['Hx', 'Tx', 'Yx', 'Ix', 'Jx', 'TxQ', 'Ux', 'TxA', 'Px', 'Kx', 'Sx', 'HxA', 'HxQ', 'UxN', 'TxN', 'Mx', 'IxQ', 'UxA', 'YxP', 'KxQ']
                                                                                           var pack_mcus_list = actuator_select.add(settings,Joint_name+"_mcus_pack",packages_list).name("Packages")
                                                                                           pack_mcus_list.setValue('Non-select'); 
                                                                                           pack_mcus_list.onChange(function(values_package){
                                                                                                      console.log("Package_list ",values_package);
                                                                                                      mcus_packages_dat['Package_list'] = values_package; 
                    
                                                                                            
                                                                                           fetch('/mcus_pin_data', {
                                                                                                  // Declare what type of data we're sending
                                                                                                  headers: {
                                                                                                           'Content-Type': 'application/json'
                                                                                                  },
                                                                                                  // Specify the method
                                                                                                  method: 'POST',
                                                                                                  // A JSON payload
                                                                                                  body: JSON.stringify({
                                                                                                  "email": JSON.parse(atob(document.getElementById('email_data').value)),'mcus':value_mcus_code,'packages_mcus':values_package
                                                                                           })
                                                                                           }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                           return response.text();
                                                                                           }).then(function (text) {
                                                                                           console.log('POST response: ');
                                                                                           // Should be 'OK' if everything was successful
                                                                                                    var mcus_pin_list_dat = JSON.parse(text); 
                                                                                                    console.log(mcus_pin_list_dat); //       
                                                                                                    var list_pins = mcus_pin_list_dat['mcus_code']
                                                                                                    console.log(list_pins[0]);
                                                                                                    var data_mcus = [list_pins];
                                                                                                    var pr =0; 
                                                                                                    for(pr >=0;pr<=list_pins.length-1;pr++){
                                                                                                                console.log(list_pins[pr]['@Name']);                  
                                                                                                                mcus_lists_pins[list_pins[pr]['@Name']]  = {'@Poisiton':list_pins[pr]['@Position'],'@Type':list_pins[pr]['@Type']}                              
                                                                                                    
                                                                                                    } 
                                                                                                    console.log(mcus_lists_pins);     
                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                 //Classify the motor type and control data                 

                                                                                                    var io_category = mcus_IO_function['mcus_IO']   //Get the io data to classify the type of the control function and motor 
                                                                                                    var motor_type_category = Motor_type_mem['motor_type'] // Get the motor type category 
                                                                                                    
                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                            //Servo_PWM_output
                                                                                                        
                                                                                                 if(io_category == "Servo_PWM_output"){
                                                                                                    if(motor_type_category == "DC_motor"){                          
                                                                                                    Joint_name+"_mcus_pins"
                                                                                                    var mcus_pins = actuator_select.add(settings,Joint_name+"_mcus_pins",Object.keys(mcus_lists_pins)).name('Pins')
                                                                                                    mcus_pins.setValue('Non-select'); 
                                                                                                    mcus_pins.onChange(function(values_pins){
                                                                                                                console.log("Pins_function ",values_pins,mcus_lists_pins[values_pins]); 
                                                                                                                mcus_pack_list['Pins_function'] = {'pin_name':values_pins,'pin_pos_type':mcus_lists_pins[values_pins]}; //Check the pins list                              
                                                                                                                var port_com =  Communication_mem['communication']
                                                                                                                var internalcom =  request_devices_comport['com_port_devices']
                                                                                                                console.log("Data_communication_com ",internalcom); 
                                                                                                                //Check if pin is exist in the map 
                                                                                                                //console.log("STM32_mcus_list ",motor_mcus['Serial']['MCU']['STM32']);                                                                           
                                                                                                                fetch('/mcus_pin_map_data', {

                                                                                                                    // Declare what type of data we're sending
                                                                                                                    headers: {
                                                                                                                            'Content-Type': 'application/json'
                                                                                                                    },
                                                                                                                    // Specify the method
                                                                                                                    method: 'POST',
                                                                                                                    // A JSON payload
                                                                                                                    body: JSON.stringify({
                                                                                                                      "Data_map": "pin_map_mcus"
                                                                                                                })
                                                                                                                }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                                                return response.text();
                                                                                                                }).then(function (text) {
                                                                                                                console.log('POST response: ');
                                                                                                                         // Should be 'OK' if everything was successful
                                                                                                                         //console.log(text);  
                                                                                                                         var mcus_pin_map = JSON.parse(text);
                                                                                                                         var fam_mcus = mcus_families['mcus_families'] 
                                                                                                                         var mcus_codes_num = mcus_number['mcus_codes'] 
                                                                                                                         var mcus_package =   mcus_packages_dat['Package_list']
                                                                                                                         var mcus_num_codes = mcus_codes_num+mcus_package   
                                                                                                                         console.log("Mcus_code_number ",mcus_num_codes);  
                                                                                                                         console.log(mcus_pin_map[fam_mcus][mcus_num_codes]);  //Get all the list of the pin map 
                                                                                                                         var list_pins_map = Object.keys(mcus_pin_map[fam_mcus][mcus_num_codes]); 
                                                                                                                         console.log("Pins_map_list ",list_pins_map);  
                                                                                                                         if(list_pins_map.includes(values_pins) == true){
                                                                                                                                     console.log("Mcus_firmware_pins ",mcus_pin_map[fam_mcus][mcus_num_codes][values_pins]); 
                                                                                                                                     if(port_com == 'Serial'){
                                                                                                                
                                                                                                                                             //var Serial_port = Object.keys(request_devices_comport['com_port_devices']); 
                                                                                                                                             var Serial_port = ['/dev/ttyS0'] //Get the UART serial port on the single boar computer 
                                                                                                                                             Serial_port.unshift('Non-select');
                                                                                                                                             var serial_devices_port = actuator_select.add(settings,Joint_name+"_request_devices",Serial_port).name('Port')
                                                                                                                                             serial_devices_port.setValue('Non-select') 
                                                                                                                                             serial_devices_port.onChange(function(values_serial_port){
                                                                                                                                                     console.log("Serial port data",values_serial_port);
                                                                                                                                                     request_port_coms['Communication_port']   = values_serial_port  //Get the serial port data of the microcontroller                                        
                                                                                                                                      });
                                                                                                                                      //Fetch the analog sensor data here into the list
                                                                                                                                      var data_container = {"Mcus_familiy": mcus_families['mcus_families'] ,"Mcus_name": mcus_num_codes} 
                                                                                                                                      console.log("Data_containner ",data_container); 
                                                                                                                                                                                                                                                                                         
                                                                                                                                                               // POST
                                                                                                                                                               settings["feedback_sensor"] = false;  // Set the feedback sensor as default   
                                                                                                                                                               var feed_back_status = actuator_select.add(settings,"feedback_sensor").name("Select feedback sensor")
                                                                                                                                                               feed_back_status.onChange(function(values_feed_back){
                                                                                                                                                                              console.log("Feed back sensor status ",values_feed_back); //Get the feedback sensor settings     
                                                                                                                                                                              if(values_feed_back == true){
                                                                                                                                                                                          console.log("Activate sensor feedback selection"); 

                                                                                                                                                                                          settings["feedback_sensor"] = "Non-select"; 
                                                                                                                                                                                                    
                                                                                                                                                                                                    var Feed_back_sensor_list = ["Analog-read","UART"];  
                                                                                                                                                                                                    Feed_back_sensor_list.unshift("Non-select"); 
                                                                                                                                                                                                    var sensor_feedback = actuator_select.add(settings,"feedback_sensor",Feed_back_sensor_list).name("Feedback_sensor") 
                                                                                                                                                                                                    sensor_feedback.setValue("Non-select"); 
                                                                                                                                                                                                    sensor_feedback.onChange(function(values_sensors){
                                                                                                                                                                                                                        console.log("Sensor feedback in ",values_sensors); //Get the sensor feedback data 
                                                                                                                                                                                                                        
                                                                                                                                                                                        if(values_sensors == "Analog-read"){
                                                                                                                                                                                               feedback_sensor["sensor_feed_back"] = values_sensors; //Sensor 
                                                                                                                                                                                               fetch('/Mcus_analog_read', {

                                                                                                                                                                                                    // Declare what type of data we're sending 
                                                                                                                                                                                                    headers: {
                                                                                                                                                                                                             'Content-Type': 'application/json'
                                                                                                                                                                                                    },

                                                                                                                                                                                                    // Specify the method
                                                                                                                                                                                                    method: 'POST',

                                                                                                                                                                                                    // A JSON payload
                                                                                                                                                                                                    body: JSON.stringify({
                                                                                                                                                                                                    "Mcus_familiy": mcus_families['mcus_families'] ,"Mcus_name": mcus_num_codes
                                                                                                                                                                                                    })
                                                                                                                                                                                                    }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                                                                                                                                    return response.text(); 
                                                                                                                                                                                                    }).then(function (text) {
                                                                                                                                                                                                    console.log('POST response: ');
                                                                                                                                                                                                    // Should be 'OK' if everything was successful
                                                                                                                                                                                                    var analog_pin_list = JSON.parse(text); 
                                                                                                                                                                                                    
                                                                                                                                                                                                    console.log("List analog pin ",analog_pin_list); 
                                                                                                                                                                                                    settings["analog_fb"] = "Non-select"; 
                                                                                                                                                                                                    var analog_chip_name  = Object.keys(analog_pin_list); // Get the chip name data 
                                                                                                                                                                                                    analog_chip_name.unshift("Non-select");   
                                                                                                                                                                                                    var analog_read_fb = actuator_select.add(settings,"analog_fb",analog_chip_name).name(Joint_name+"_Analog-read")
                                                                                                                                                                                                    analog_read_fb.setValue("Non-select"); 
                                                                                                                                                                                                    analog_read_fb.onChange(function(values_analogs){

                                                                                                                                                                                                             console.log("Selected analog pin ",values_analogs,analog_pin_list[values_analogs],mcus_lists_pins[values_analogs]); // Also get the position of the analog pin mapping into the system                                                                        
                                                                                                                                                                                                             analog_pin_sensor["Pin_analog_data"] = {"Pin_name":values_analogs,"mcus_analog_pin":analog_pin_list[values_analogs],"mcus_analog_position":mcus_lists_pins[values_analogs]}; // Also get the position of the analog pin mapping into the system                                                                        
                                                                                                                                                                                                                                         
                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                })
                                                                                                                                                                                           }
                                                                                                                                                                                           

                                                                                                                                                                                   });
                                                                                                                                                                              }
                                                                                                                                                               })                                                                                                                                                        
                                                                                                                                                                 
                                                                                                                                                                                
                                                                                                                                                                
                                                                                                                                    }  
                                                                                                                                      if(port_com == 'I2C'){
                                                                                                                
                                                                                                                                                var Address_port = Object.values(request_devices_comport['com_port_devices']); 
                                                                                                                                                Address_port.unshift('Non-select');
                                                                                                                                                var address_devices = actuator_select.add(settings,Joint_name+"_request_devices",Address_port).name('Address')
                                                                                                                                                address_devices.setValue('Non-select') 
                                                                                                                                                address_devices.onChange(function(values_address){
                                                                                                                                                         console.log("Address data",values_address);   
                                                                                                                                                         request_port_coms['Communication_port'] = values_address;  //Servo I2C or I2C serial hardware control devices 

                                                                                                                                     });

                                                                                                                                    } 

                                                                                                                                       actuator_select.add(settings,'joint_hardware_gen').name(Joint_name+"_add_joint") 
                                                                                                                        }
                                                                                                                        if(list_pins_map.includes(values_pins) == false){
                                                                                                                                    
                                                                                                                                        alert("This pin is not in the list of the standard firmata pin map");     
                                                                                                                        }
                                                                                                                });

                                                                                                                


 
                                                                                                    });
                                                                                                     }
                                                                                                                                                    //End checking the data of the pin pin function as Servo_PWM_output
                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                }                
                                                                                                //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                    //PWM_output                                      
                                                                                                if(io_category == "PWM_output"){
                                                                                                    if(motor_type_category == "DC_motor"){    

                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                            // Pin_1 pwm  motor                            
                                                                                                    var pin_pwm_out = {};
                                                                                                    Joint_name+"_mcus_pins"
                                                                                                    var mcus_pins = actuator_select.add(settings,Joint_name+"_mcus_pins",Object.keys(mcus_lists_pins)).name('Pins_L')
                                                                                                    mcus_pins.setValue('Non-select'); 
                                                                                                    mcus_pins.onChange(function(values_pins){
                                                                                                                console.log("Pins_function ",values_pins,mcus_lists_pins[values_pins]);
                                                                                                                pin_pwm_out['Pin_L'] = {'pin_name':values_pins,'pin_pos_type':mcus_lists_pins[values_pins]}; 
                                                                                                                mcus_pack_list['Pins_function'] = pin_pwm_out;    
                                                                                                                var port_com =  Communication_mem['communication']
                                                                                                                var internalcom =  request_devices_comport['com_port_devices']
                                                                                                                console.log("Data_communication_com ",internalcom); 
                                                                                                                //Check if pin is exist in the map 
                                                                                                                //console.log("STM32_mcus_list ",motor_mcus['Serial']['MCU']['STM32']);                                                                           
                                                                                                                fetch('/mcus_pin_map_data', {

                                                                                                                    // Declare what type of data we're sending
                                                                                                                    headers: {
                                                                                                                            'Content-Type': 'application/json'
                                                                                                                    },
                                                                                                                    // Specify the method
                                                                                                                    method: 'POST',
                                                                                                                    // A JSON payload
                                                                                                                    body: JSON.stringify({
                                                                                                                      "Data_map": "pin_map_mcus"
                                                                                                                })
                                                                                                                }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                                                return response.text();
                                                                                                                }).then(function (text) {
                                                                                                                console.log('POST response: ');
                                                                                                                         // Should be 'OK' if everything was successful
                                                                                                                         //console.log(text);  
                                                                                                                         var mcus_pin_map = JSON.parse(text);
                                                                                                                         var fam_mcus = mcus_families['mcus_families'] 
                                                                                                                         var mcus_codes_num = mcus_number['mcus_codes'] 
                                                                                                                         var mcus_package =   mcus_packages_dat['Package_list']
                                                                                                                         var mcus_num_codes = mcus_codes_num+mcus_package   
                                                                                                                         console.log("Mcus_code_number ",mcus_num_codes);  
                                                                                                                         console.log(mcus_pin_map[fam_mcus][mcus_num_codes]);  //Get all the list of the pin map 
                                                                                                                         var list_pins_map = Object.keys(mcus_pin_map[fam_mcus][mcus_num_codes]); 
                                                                                                                         console.log("Pins_map_list ",list_pins_map);  
                                                                                                                         if(list_pins_map.includes(values_pins) == true){
                                                                                                                                     console.log("Mcus_firmware_pins ",mcus_pin_map[fam_mcus][mcus_num_codes][values_pins]); 
                                                                                                                                               
                                                                                                                        }
                                                                                                                        if(list_pins_map.includes(values_pins) == false){
                                                                                                                                    
                                                                                                                                        alert("This pin is not in the list of the standard firmata pin map");     
                                                                                                                        }
                                                                                                                });

                                                                                                                


 
                                                                                                    });
                                                                                                    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                     //Pin 2 output pwm  
                                                                                                    Joint_name+"_mcus_pins"
                                                                                                    var mcus_pins = actuator_select.add(settings,Joint_name+"_mcus_pins",Object.keys(mcus_lists_pins)).name('Pins_R')
                                                                                                    mcus_pins.setValue('Non-select'); 
                                                                                                    mcus_pins.onChange(function(values_pins){
                                                                                                                console.log("Pins_function ",values_pins,mcus_lists_pins[values_pins]); 
                                                                                                                pin_pwm_out['Pin_R'] = {'pin_name':values_pins,'pin_pos_type':mcus_lists_pins[values_pins]}; 
                                                                                                                mcus_pack_list['Pins_function'] = pin_pwm_out;
                                                                                                                var port_com =  Communication_mem['communication']
                                                                                                                var internalcom =  request_devices_comport['com_port_devices']
                                                                                                                console.log("Data_communication_com ",internalcom); 
                                                                                                                //Check if pin is exist in the map 
                                                                                                                //console.log("STM32_mcus_list ",motor_mcus['Serial']['MCU']['STM32']);                                                                           
                                                                                                                fetch('/mcus_pin_map_data', {

                                                                                                                    // Declare what type of data we're sending
                                                                                                                    headers: {
                                                                                                                            'Content-Type': 'application/json'
                                                                                                                    },
                                                                                                                    // Specify the method
                                                                                                                    method: 'POST',
                                                                                                                    // A JSON payload
                                                                                                                    body: JSON.stringify({
                                                                                                                      "Data_map": "pin_map_mcus"
                                                                                                                })
                                                                                                                }).then(function (response) { // At this point, Flask has printed our JSON
                                                                                                                return response.text();
                                                                                                                }).then(function (text) {
                                                                                                                console.log('POST response: ');
                                                                                                                         // Should be 'OK' if everything was successful
                                                                                                                         //console.log(text);  
                                                                                                                         var mcus_pin_map = JSON.parse(text);
                                                                                                                         var fam_mcus = mcus_families['mcus_families'] 
                                                                                                                         var mcus_codes_num = mcus_number['mcus_codes'] 
                                                                                                                         var mcus_package =   mcus_packages_dat['Package_list']
                                                                                                                         var mcus_num_codes = mcus_codes_num+mcus_package   
                                                                                                                         console.log("Mcus_code_number ",mcus_num_codes);  
                                                                                                                         console.log(mcus_pin_map[fam_mcus][mcus_num_codes]);  //Get all the list of the pin map 
                                                                                                                         var list_pins_map = Object.keys(mcus_pin_map[fam_mcus][mcus_num_codes]); 
                                                                                                                         console.log("Pins_map_list ",list_pins_map);  
                                                                                                                         if(list_pins_map.includes(values_pins) == true){
                                                                                                                                     console.log("Mcus_firmware_pins ",mcus_pin_map[fam_mcus][mcus_num_codes][values_pins]); 
                                                                                                                                     if(port_com == 'Serial'){
                                                                                                                
                                                                                                                                             var Serial_port = Object.keys(request_devices_comport['com_port_devices']); 
                                                                                                                                             Serial_port.unshift('Non-select');
                                                                                                                                             var serial_devices_port = actuator_select.add(settings,Joint_name+"_request_devices",Serial_port).name('Port')
                                                                                                                                             serial_devices_port.setValue('Non-select') 
                                                                                                                                             serial_devices_port.onChange(function(values_serial_port){
                                                                                                                                                     console.log("Serial port data",values_serial_port);
                                                                                                                                                     request_port_coms['Communication_port']   = values_serial_port  //Get the serial port data of the microcontroller                                        
                                                                                                                                      });                    
                                                                                                                                      }  
                                                                                                                                      if(port_com == 'I2C'){
                                                                                                                
                                                                                                                                                var Address_port = Object.values(request_devices_comport['com_port_devices']); 
                                                                                                                                                Address_port.unshift('Non-select');
                                                                                                                                                var address_devices = actuator_select.add(settings,Joint_name+"_request_devices",Address_port).name('Address')
                                                                                                                                                address_devices.setValue('Non-select') 
                                                                                                                                                address_devices.onChange(function(values_address){
                                                                                                                                                         console.log("Address data",values_address);   
                                                                                                                                                         request_port_coms['Communication_port'] = values_address;  //Servo I2C or I2C serial hardware control devices 

                                                                                                                                     });                    
                                                                                                                                    } 

                                                                                                                                       actuator_select.add(settings,'joint_hardware_gen').name(Joint_name+"_add_joint") 
                                                                                                                        }
                                                                                                                        if(list_pins_map.includes(values_pins) == false){
                                                                                                                                    
                                                                                                                                        alert("This pin is not in the list of the standard firmata pin map");     
                                                                                                                        }
                                                                                                                });

                                                                                                                


 
                                                                                                    });
                                                                                                                                     


                                                                                                     }
                                                                                                                                                    //End checking the data of the pin pin function as PWM_output
                                                                                                     //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                                                                                                                                                                                           

                                                                                                } 
                                                                                               
                                                                                           });
                                                                                                    
                                                                                           //actuator_select.add(settings,'joint_hardware_gen').name(Joint_name+"_add_joint")

                                                                                        })    
                                                                                            // Add joint control function to control the real servo motor
                                                                                       
                                                                        });         
                                                                    });
                                                                    //Addjoint after category selected

                                                                       
                                                      });     
                                                      //actuator_select.add(settings,'joint_hardware_gen').name(Joint_name+"_add_joint") // Add joint control function to control the real servo motor 
                                                                   
                                       })
                                         */                                                            
                                            }
                                            if(Communication_mem['communication'] == "SPI"){
                                                       console.log("SPI select on the single-board")

                                            }
                                            if(Communication_mem['communication'] == "I2C"){
                                                    //Request the data from the back-end on the data request from the github device data 
                                                    // POST
                                                    fetch('/data_i2c_control_board', {
                                                     // Declare what type of data we're sending
                                                     headers: {
                                                       'Content-Type': 'application/json'
                                                     },
                                                    // Specify the method
                                                    method: 'POST',
                                                    // A JSON payload
                                                    body: JSON.stringify({
                                                            "command": "I2C_control"
                                                    })
                                                   }).then(function (response) { // At this point, Flask has printed our JSON
                                                   return response.text();
                                                   }).then(function (text) {
                                                   console.log('POST response: ');
                                                   // Should be 'OK' if everything was successful
                                                   var data_container_i2c = JSON.parse(text); 
                                                   settings["i2c_board_control"] = "Non-select"; 
                                                   //Fetch the back-end here  and get the list data key 
                                                   var data_control_boards = Object.keys(data_container_i2c); // Container lisst of the board control with the I2C address data 

                                                   var i2c_control_devices_select = actuator_select.add(settings,"i2c_board_control",data_control_boards).name("I2C_control_board") 
                                                   i2c_control_devices_select.setValue("Non-select") 
                                                   i2c_control_devices_select.onChange(function(values_i2c){
                                                           compo_devices_i2c_control['i2c_control'] =  values_i2c          
                                                           console.log("Board_i2c_control: ",values_i2c);
                                                           settings['Internal_i2c_gpio_cont'] = "Non-select" 
                                                           var  gpio_i2c_boards = actuator_select.add(settings,"Internal_i2c_gpio_cont",data_container_i2c[values_i2c]).name("GPIOs")
                                                           gpio_i2c_boards.onChange(function(gpio_pins_num){
                                                                           console.log("GPIO_number: ",gpio_pins_num); 
                                                                           //Add the pin function button here to activate the memorization of the data specification 
                                                                           i2c_gpio_pin['i2c_GPIO'] = gpio_pins_num;

                                                           }); 
                                                           actuator_select.add(settings,'joint_hardware_gen').name(Joint_name+"_add_joint");                                                                           
                                                   });                      
                                        });
                                    
                                }
                            }
                            
                                 }); 
                             });
                                                           
                  })      
       }    
        fetch('/joint_list_data', {

// Declare what type of data we're sending
headers: {
  'Content-Type': 'application/json'
},

// Specify the method
method: 'POST',

// A JSON payload
body: JSON.stringify({
    "email": JSON.parse(atob(document.getElementById('email_data').value))
})
}).then(function (response) { // At this point, Flask has printed our JSON
return response.text();
}).then(function (text) {

console.log('POST response: ');
  // Should be 'OK' if everything was successful
     var joint_data_extract = JSON.parse(text);
     console.log(joint_data_extract,typeof(joint_data_extract));  

        var joint_name_lists = Object.keys(joint_data_extract['joint']) 
        var rj =0; 
        for(rj>=0; rj<=joint_name_lists.length-1;rj++){
                       joint_static[joint_name_lists[rj]] = [];  //Get all the joint array
        }
        joint_name_lists.unshift('Non-select');
        var joint_gen = Joint_hardware.add(settings,'joint_created',joint_name_lists).name('Joints_name')
        joint_gen.setValue("Non-select"); 
        joint_gen.onChange(function(Joint_name){
                   var joint_types = joint_data_extract['joint'][Joint_name]['type']
                   console.log('Get_joint_name ',Joint_name); 
                   console.log('Get_joint_type ',joint_data_extract['joint'][Joint_name]['type'])
                   //Add joint type data from the joint name data 
                   //Select communication protocol
                   Joint_type_motor_control(Joint_hardware,Joint_name,joint_types)  //Get the joint type from the response json to classify the control function of the real hadware 
                   Joint_type_ref["Joints_type"] = joint_type    //Get the joint type data                  
         
        });
    });
    Joint_hardware.open();   
    //Support only revolute joints and prismatic joints control   
    var motion_Recorder = gui.addFolder("Motion play and record");  
    var select_rec_sense = motion_Recorder.addFolder("Select model or sensor");
    select_rec_sense.add(settings,'Start_record').name("Model_recorder"); 
    select_rec_sense.add(settings,"Start_sensor_rec").name("Sensor_recorder"); 
    motion_Recorder.add(settings,'Stop_record').name("Stop_record"); 
    motion_Recorder.add(settings,'play_recorder').name("Play_record"); 
    motion_Recorder.add(settings,'save_recorder').name("Save_recorded");
    select_rec_sense.open(); //Open the folder of  
    motion_Recorder.open(); //open the folder of the motion recorder  
    var export_record = gui.addFolder("Export_recorded_motion") // Export the recorded motion 
    export_record.add(settings,"export_motion",).name("Export") 
    var joint_post_gen = gui.addFolder("Joints_generator_control") //Joint post request
    joint_post_gen.add(settings,'joint_post_dat').name("Joints_code_gen");


        import * as THREE from 'three';
        //import { registerDragEvents } from 'dragAndDrop';
        // Converts a datatransfer structer into an object with all paths and files
// listed out. Returns a promise that resolves with the file structure.
function dataTransferToFiles(dataTransfer) {

if (!(dataTransfer instanceof DataTransfer)) {

    throw new Error('Data must be of type "DataTransfer"', dataTransfer);

}

const files = {};

// recurse down the webkit file structure resolving
// the paths to files names to store in the `files`
// object
function recurseDirectory(item) {

    if (item.isFile) {

        return new Promise(resolve => {
            item.file(file => {
                files[item.fullPath] = file;
                resolve();
            });
        });

    } else {

        const reader = item.createReader();

        return new Promise(resolve => {

            const promises = [];

            // exhaustively read all the directory entries
            function readNextEntries() {

                reader.readEntries(et => {

                    if (et.length === 0) {

                        Promise.all(promises).then(() => resolve());

                    } else {

                        et.forEach(e => {

                            promises.push(recurseDirectory(e));

                        });
                        readNextEntries();

                    }

                });

            }

            readNextEntries();

        });
    }
}

return new Promise(resolve => {

    // Traverse down the tree and add the files into the zip
    const dtitems = dataTransfer.items && [...dataTransfer.items];
    const dtfiles = [...dataTransfer.files];

    if (dtitems && dtitems.length && dtitems[0].webkitGetAsEntry) {

        const promises = [];
        for (let i = 0; i < dtitems.length; i++) {
            const item = dtitems[i];
            const entry = item.webkitGetAsEntry();

            promises.push(recurseDirectory(entry));

        }
        Promise.all(promises).then(() => resolve(files));

    } else {

        // add a '/' prefix to math the file directory entry
        // on webkit browsers
        dtfiles
            .filter(f => f.size !== 0)
            .forEach(f => files['/' + f.name] = f);

        resolve(files);

    }
});
}
export function registerDragEvents(viewer, callback) {

document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('dragenter', e => e.preventDefault());
document.addEventListener('drop', e => {

    e.preventDefault();

    // convert the files
    dataTransferToFiles(e.dataTransfer)
        .then(files => {

            // removes '..' and '.' tokens and normalizes slashes
            const cleanFilePath = path => {

                return path
                    .replace(/\\/g, '/')
                    .split(/\//g)
                    .reduce((acc, el) => {

                        if (el === '..') acc.pop();
                        else if (el !== '.') acc.push(el);
                        return acc;

                    }, [])
                    .join('/');

            };

            // set the loader url modifier to check the list
            // of files
            const fileNames = Object.keys(files).map(n => cleanFilePath(n));
            viewer.urlModifierFunc = url => {

                // find the matching file given the requested url
                const cleaned = cleanFilePath(url.replace(viewer.package, ''));
                const fileName = fileNames
                    .filter(name => {

                        // check if the end of file and url are the same
                        const len = Math.min(name.length, cleaned.length);
                        return cleaned.substr(cleaned.length - len) === name.substr(name.length - len);

                    }).pop();

                if (fileName !== undefined) {

                    // revoke the url after it's been used
                    const bloburl = URL.createObjectURL(files[fileName]);
                    requestAnimationFrame(() => URL.revokeObjectURL(bloburl));

                    return bloburl;

                }

                return url;

            };

            // set the source of the element to the most likely intended display model
            const filesNames = Object.keys(files);
            viewer.up = '+Z';
            document.getElementById('up-select').value = viewer.up;

            // filter all files ending in urdf
            const availableModels = fileNames.filter(n => /urdf$/i.test(n));
            // remove existing entries from #urdf-options
            const urdfOptionsContainer = document.querySelector('#urdf-options');

            while (urdfOptionsContainer.firstChild){
                
                urdfOptionsContainer.removeChild(urdfOptionsContainer.firstChild);
            }
            // create new entries in #urdf-options
            availableModels.forEach(model => {
                const li = document.createElement('li');
                li.setAttribute('urdf', model);
                li.setAttribute('color', '#263238');
                // extract filename from full path
                li.textContent = model.split(/[\\\/]/).pop();
                urdfOptionsContainer.appendChild(li);
            
            });

            viewer.urdf =
                filesNames
                    .filter(n => /urdf$/i.test(n))
                    .shift();

        }).then(() => callback());

});

}    
import { STLLoader } from '../static/three/examples/jsm/loaders/STLLoader.js';
import { GLTFLoader } from '../static/three/examples/jsm/loaders/GLTFLoader.js';
import { ColladaLoader } from '../static/three/examples/jsm/loaders/ColladaLoader.js';
import { OBJLoader } from '../static/three/examples/jsm/loaders/OBJLoader.js';
import { VTKLoader } from '../static/three/examples/jsm/loaders/VTKLoader.js';
import URDFManipulator from '../static/urdf-manipulator-element.js';
customElements.define('urdf-viewer', URDFManipulator);

// declare these globally for the sake of the example.
// Hack to make the build work with webpack for now.
// TODO: Remove this once modules or parcel is being used
const viewer = document.querySelector('urdf-viewer');

const limitsToggle = document.getElementById('ignore-joint-limits');
const collisionToggle = document.getElementById('collision-toggle');
const radiansToggle = document.getElementById('radians-toggle');
const autocenterToggle = document.getElementById('autocenter-toggle');
const upSelect = document.getElementById('up-select');
const sliderList = document.querySelector('#controls ul');
const controlsel = document.getElementById('controls');
const controlsToggle = document.getElementById('toggle-controls');
const animToggle = document.getElementById('do-animate');
const DEG2RAD = Math.PI / 180;
const RAD2DEG = 1 / DEG2RAD;
let sliders = {};

// Global Functions
const setColor = color => {

    document.body.style.backgroundColor = color;
    viewer.highlightColor = '#' + (new THREE.Color(0xffffff)).lerp(new THREE.Color(color), 0.35).getHexString();

};

// Events
// toggle checkbox
limitsToggle.addEventListener('click', () => {
    limitsToggle.classList.toggle('checked');
    viewer.ignoreLimits = limitsToggle.classList.contains('checked');
});

radiansToggle.addEventListener('click', () => {
    radiansToggle.classList.toggle('checked');
    Object
        .values(sliders)
        .forEach(sl => sl.update());
});

collisionToggle.addEventListener('click', () => {
    collisionToggle.classList.toggle('checked');
    viewer.showCollision = collisionToggle.classList.contains('checked');
});

autocenterToggle.addEventListener('click', () => {
    autocenterToggle.classList.toggle('checked');
    viewer.noAutoRecenter = !autocenterToggle.classList.contains('checked');
});

upSelect.addEventListener('change', () => viewer.up = upSelect.value);

controlsToggle.addEventListener('click', () => controlsel.classList.toggle('hidden'));

// watch for urdf changes
viewer.addEventListener('urdf-change', () => {

    Object
        .values(sliders)
        .forEach(sl => sl.remove());
    sliders = {};

});

viewer.addEventListener('ignore-limits-change', () => {

    Object
        .values(sliders)
        .forEach(sl => sl.update());

});

viewer.addEventListener('angle-change', e => {

    if (sliders[e.detail]) sliders[e.detail].update();

});

viewer.addEventListener('joint-mouseover', e => {

    const j = document.querySelector(`li[joint-name="${ e.detail }"]`);
    if (j) j.setAttribute('robot-hovered', true);

});

viewer.addEventListener('joint-mouseout', e => {

    const j = document.querySelector(`li[joint-name="${ e.detail }"]`);
    if (j) j.removeAttribute('robot-hovered');

});

let originalNoAutoRecenter;
viewer.addEventListener('manipulate-start', e => {

    const j = document.querySelector(`li[joint-name="${ e.detail }"]`);
    if (j) {
        j.scrollIntoView({ block: 'nearest' });
        window.scrollTo(0, 0);
    }

    originalNoAutoRecenter = viewer.noAutoRecenter;
    viewer.noAutoRecenter = true;

});

viewer.addEventListener('manipulate-end', e => {

    viewer.noAutoRecenter = originalNoAutoRecenter;

});
var account_payload = document.getElementById('email_data').value
var account_Data = JSON.parse(atob(account_payload)); 
var profile_payload = {}; // Send the profile control joint data into the json of the IoT request data 
var joint_package = {} 
var joint_type = {}; 
var data_joint_angle = {}; //Get all the data joint angle control to control the motion planning and teach robot motion system automatically move with high precision 
//console.log(account_Data); 
function IoT_control_joint(account_Data,joint_types,data_joint_angle){
       
       var email = account_Data['email'] 
       var project_name = account_Data['project_name']        
       //console.log(email,project_name,data_joint_angle); 
       joint_type[joint_types] = data_joint_angle;
       joint_package[project_name] = joint_type; 
       profile_payload[email] = joint_package; 
       console.log(profile_payload); // get the profile payload 
       //Fetch the payload
       // POST
       fetch('/IoT_connect', {
          // Declare what type of data we're sending
          headers: {
                 'Content-Type': 'application/json'
          },
         // Specify the method
         method: 'POST',
         // A JSON payload
         body: JSON.stringify(profile_payload)
         }).then(function (response) { // At this point, Flask has printed our JSON
         return response.text();
         }).then(function (text) {
          console.log('POST response: ');
          // Should be 'OK' if everything was successful
               console.log(text);
                
        });
      }
// create the sliders
viewer.addEventListener('urdf-processed', () => {

    const r = viewer.robot;
    Object
        .keys(r.joints)
        .sort((a, b) => {

            const da = a.split(/[^\d]+/g).filter(v => !!v).pop();
            const db = b.split(/[^\d]+/g).filter(v => !!v).pop();

            if (da !== undefined && db !== undefined) {
                const delta = parseFloat(da) - parseFloat(db);
                if (delta !== 0) return delta;
            }

            if (a > b) return 1;
            if (b > a) return -1;
            return 0;

        })
        .map(key => r.joints[key])
        .forEach(joint => {

            const li = document.createElement('li');
            li.innerHTML =
            `
            <span title="${ joint.name }">${ joint.name }</span>
            <input type="range" value="0" step="0.0001"/>
            <input type="number" step="0.0001" />
            `;
            li.setAttribute('joint-type', joint.jointType);
            li.setAttribute('joint-name', joint.name);

            sliderList.appendChild(li);

            // update the joint display
            const slider = li.querySelector('input[type="range"]');
            const input = li.querySelector('input[type="number"]');
            li.update = () => {
                const degMultiplier = radiansToggle.classList.contains('checked') ? 1.0 : RAD2DEG;
                let angle = joint.angle;

                if (joint.jointType === 'revolute' || joint.jointType === 'continuous') {
                    angle *= degMultiplier;
                }

                if (Math.abs(angle) > 1) {
                    angle = angle.toFixed(1);
                    //console.log("Fixed angle ",joint.name,joint.jointType,angle)
                    data_joint_angle[joint.name] = angle;
                    //console.log(data_joint_angle);
                    IoT_control_joint(account_Data,joint.jointType,data_joint_angle);
                    if(Motion_rec['Start_rec'] != undefined){
                                if(Object.keys(Motion_rec['Start_rec'])[0] == "Model"){
                                               
                                            console.log("Recording joint from the 3d model")
                                            joint_static[joint.name].push(parseFloat(angle))   
                                            console.log(joint_static);  
                                }
                                if(Object.keys(Motion_rec["Start_rec"]) == "Save_record"){
                           
                           console.log("Save the motion record ",joint_static);
                           
                           //Fetch back the data recorder into the back end code 
                           //Data will consist of email project name host machine name                 
                           fetch('/Recorded_joint_data',{
                                       // Declare what type of data we're sending
                                   headers: {
                                      'Content-Type': 'application/json'
                                   },
                                  // Specify the method
                                  method: 'POST',
                                  // A JSON payload
                                  body: JSON.stringify({"email":JSON.parse(atob(document.getElementById('email_data').value))['email']
                                  ,"joints_recorded":joint_static
                               })
                           }).then(function (response) { // At this point, Flask has printed our JSON
                           return response.text();
                           }).then(function (text) {
                           console.log('POST response: ');
                                   // Should be 'OK' if everything was successful
                                   var motion_data = JSON.parse(text);
                                   console.log("Response from save data",motion_data)
                                   //alert("Save recorded joints data successfully!")

                        });

                } 

                    }
                } else {
                    angle = angle.toPrecision(2);
                    //console.log("Precision angle ",joint.name,joint.jointType,angle)
                    data_joint_angle[joint.name] = angle;
                    //console.log(data_joint_angle);  
                    IoT_control_joint(account_Data,joint.jointType,data_joint_angle); 
                    if(Motion_rec['Start_rec'] != undefined){
                                if(Object.keys(Motion_rec['Start_rec'])[0] == "Model"){
                                               
                                            console.log("Recording joint from the 3d model")
                                            joint_static[joint.name].push(parseFloat(angle))    
                                            console.log(joint_static); 
                                }
                                if(Object.keys(Motion_rec["Start_rec"]) == "Save_record"){
                           
                           console.log("Save the motion record ",joint_static);
                           
                           //Fetch back the data recorder into the back end code 
                           //Data will consist of email project name host machine name                 
                           fetch('/Recorded_joint_data',{
                                       // Declare what type of data we're sending
                                   headers: {
                                      'Content-Type': 'application/json'
                                   },
                                  // Specify the method
                                  method: 'POST',
                                  // A JSON payload
                                  body: JSON.stringify({"email":JSON.parse(atob(document.getElementById('email_data').value))['email']
                                  ,"joints_recorded":joint_static
                               })
                           }).then(function (response) { // At this point, Flask has printed our JSON
                           return response.text();
                           }).then(function (text) {
                           console.log('POST response: ');
                                   // Should be 'OK' if everything was successful
                                   var motion_data = JSON.parse(text);
                                   console.log("Response from save data",motion_data)
                                   //alert("Save recorded joints data successfully!")

                        });

                } 

                    }
                }
                
                input.value = parseFloat(angle);

                // directly input the value
                slider.value = joint.angle;
                
                if (viewer.ignoreLimits || joint.jointType === 'continuous') {
                    slider.min = -6.28;
                    slider.max = 6.28;

                    input.min = -6.28 * degMultiplier;
                    input.max = 6.28 * degMultiplier;
                } else {
                    slider.min = joint.limit.lower;
                    slider.max = joint.limit.upper;

                    input.min = joint.limit.lower * degMultiplier;
                    input.max = joint.limit.upper * degMultiplier;
                }
            };

            switch (joint.jointType) {

                case 'continuous':
                case 'prismatic':
                case 'revolute':
                    break;
                default:
                    li.update = () => {};
                    input.remove();
                    slider.remove();

            }

            slider.addEventListener('input', () => {
                viewer.setJointValue(joint.name, slider.value);
                li.update();
            });

            input.addEventListener('change', () => {
                const degMultiplier = radiansToggle.classList.contains('checked') ? 1.0 : RAD2DEG;
                viewer.setJointValue(joint.name, input.value * degMultiplier);
                li.update();
            });

            li.update();

            sliders[joint.name] = li;

        });

});

document.addEventListener('WebComponentsReady', () => {

    viewer.loadMeshFunc = (path, manager, done) => {

        const ext = path.split(/\./g).pop().toLowerCase();
        switch (ext) {

            case 'gltf':
            case 'glb':
                new GLTFLoader(manager).load(
                    path,
                    result => done(result.scene),
                    null,
                    err => done(null, err),
                );
                break;
            case 'obj':
                new OBJLoader(manager).load(
                    path,
                    result => done(result),
                    null,
                    err => done(null, err),
                );
                break;
            case 'dae':
                new ColladaLoader(manager).load(
                    path,
                    result => done(result.scene),
                    null,
                    err => done(null, err),
                );
                break;
            case 'stl':
                new STLLoader(manager).load(
                    path,
                    result => {
                        const material = new THREE.MeshPhongMaterial();
                        const mesh = new THREE.Mesh(result, material);
                        done(mesh);
                    },
                    null,
                    err => done(null, err),
                );
                break;

        }

    };

    document.querySelector('li[urdf]').dispatchEvent(new Event('click'));

    if (/javascript\/example\/bundle/i.test(window.location)) {
        viewer.package = '../../../urdf';
    }

    registerDragEvents(viewer, () => {
        setColor('#263238');
        animToggle.classList.remove('checked');
        updateList();
    });

});

function Kalman_filter(input_analog_patamters){
             console.log("Activating calman filter.......")

}
var data_joints_iter = {};
var data_joint_record = {};  
// init 2D UI and animation
const updateAngles = () => {
    // Control the animation feedback from the input of the IoT sensor here   
    if (!viewer.setJointValue) return;

    // reset everything to 0 first
    //const resetJointValues = viewer.angles; Kalman
    
    //for (const name in resetJointValues) resetJointValues[name] = 0;
    //viewer.setJointValues(resetJointValues);    

    // animate the legs
    //var kf = new KalmanFilter();
    const time = Date.now() / 3e2;
    //console.log("Loop check iteration")
    //While animation running the speech recognition and other automated system will be connect and run to analyze the system in real-time 
    //Fetch all the joints function here and running inside the loop 
    // POST
    //console.log(JSON.parse(atob(document.getElementById('email_data').value))['email']); 
    //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>..
                        //Before start anything please check if the selection is string or dictionnary 
                        //If string check if Stop_recorder_motion or Play_record 
    //execute the method of the function 
    //if(Object.keys(Motion_rec['Start_rec']) = "Play_record"){
       //console.log("Current command",Object.keys(Motion_rec['Start_rec']))
       console.log("Status of recorder ",Motion_rec)
        
       fetch('/feedback_motion_control', {
         // Declare what type of data we're sending
         headers: {
              'Content-Type': 'application/json'
         },
        // Specify the method
        method: 'POST',
        // A JSON payload
        body: JSON.stringify({
                 "email": String(JSON.parse(atob(document.getElementById('email_data').value))['email'])
        })
        }).then(function (response) { // At this point, Flask has printed our JSON
       return response.text();
       }).then(function (text) {
       console.log('POST response: ');
       // Should be 'OK' if everything was successful
        var feedback_data_sensor = JSON.parse(text);
        //Get joint data in the loop iteration 
        //const offset = i * Math.PI / 3;
        //const ratio = Math.max(0, Math.sin(time + offset)); 
        console.log(feedback_data_sensor,Object.keys(feedback_data_sensor).length); 
        //for(let i = 0; i <= Object.keys(feedback_data_sensor).length; i++){
        const offset = Math.PI / 3;
        const ratio = Math.max(0, Math.sin(time + offset));
        const offet2  = 2*Math.PI/3; 
        const ratio2 = Math.max(0, Math.sin(time+offet2));               
                       //var joints_name = Object.keys(feedback_data_sensor)[i].split('_')
                       //console.log("Header joint part",joints_name[0]);
                       //feedback_data_sensor.get()
        //console.log("Angle output ",Object.keys(feedback_data_sensor)[i],THREE.MathUtils.lerp(-4.2, 180, ratio)); 
        //console.log(feedback_data_sensor['HY_1']['Analog-read'],feedback_data_sensor['HY_2']['Analog-read'])
        data_joints_iter['Joint_move'] = feedback_data_sensor        
        console.log(data_joints_iter)
        var joint_sensor_name = Object.keys(data_joints_iter["Joint_move"]); // Get the list of the joint sensors 
        console.log(joint_sensor_name);
        var r = 0; 
        for(r >= 0; r <=joint_sensor_name.length-1;r++){

             console.log("Joint_analog_",joint_sensor_name[r],data_joints_iter['Joint_move'][joint_sensor_name[r]]['Analog-read']);
             //var kal_fil = data_joints_iter['Joint_move'][joint_sensor_name[r]]['Analog-read'] - kf.filter(data_joints_iter['Joint_move'][joint_sensor_name[r]]['Analog-read'])
             //console.log("Error kf filter ",kal_fil)
             viewer.setJointValue(joint_sensor_name[r],(data_joints_iter['Joint_move'][joint_sensor_name[r]]['Analog-read'])*DEG2RAD); //*DEG2RAD);   
             //viewer.setJointValue("HY_2", data_joints_iter['Joint_move']["HY_2"]['Analog-read']*DEG2RAD); //*DEG2RAD); 
              
        }
        //Check the loop if the selection of the recorder is sensor 

    }); 

    if(Motion_rec["Start_rec"] != undefined){
                console.log("Reading the status of recorder: ",Object.keys(Motion_rec["Start_rec"])[0]); // Get the data record output 
                if(Object.keys(Motion_rec["Start_rec"])[0] == "Sensors"){         
                         console.log("Activatate record"); 
                         console.log(Motion_rec["Start_rec"]["Sensors"]);  // 
                         console.log("Get joint values for recorder ",data_joints_iter);   
                         console.log("Joint_data_recorder",data_joints_iter['Joint_move'])
                         var joint_list_name = Object.keys(data_joints_iter['Joint_move'])
                        
                         var rj = 0; 
                         for(rj >=0;rj<=joint_list_name.length-1;rj++){
                             var lst_dat = joint_static[joint_list_name[rj]][joint_static[joint_list_name[rj]].length-1]
                             var current_jsdat = (data_joints_iter['Joint_move'][joint_list_name[rj]]['Analog-read'])
                             if(current_jsdat != lst_dat){
                                       joint_static[joint_list_name[rj]].push(current_jsdat);
                                       console.log("Recorded_joint_data "+joint_list_name[rj],joint_static[joint_list_name[rj]],"Last data of "+joint_list_name[rj],joint_static[joint_list_name[rj]][joint_static[joint_list_name[rj]].length-1])
                                        
                            }  

                         }
                         
                         Motion_rec["Start_rec"]["Sensors"] = joint_static; //Get the recorded data to save automatically 
                         //If the data hit on save record then save the record from the motion rec right here 
                        
                         
                             
                 }
                 console.log("Motion_data_record ",Motion_rec); 
                 if(Object.keys(Motion_rec["Start_rec"]) == "Stop_record"){
                     try{
                       if(joint_lst != {}){ 
                       var rj = 0;    
                       joint_lst = Object.keys(joint_static)        
                       for(rj>=0; rj<=joint_lst.length-1; rj++){
                                    delete joint_lst[joint_lst[rj]]   
                       }
                       }
                    }
                    catch{
                         console.log("Completeletely deleted")
                    }
                }
                 if(Object.keys(Motion_rec["Start_rec"]) == "Save_record"){
                           
                            console.log("Save the motion record ",joint_static);
                            
                            //Fetch back the data recorder into the back end code 
                            //Data will consist of email project name host machine name                 
                            fetch('/Recorded_joint_data',{
                                        // Declare what type of data we're sending
                                    headers: {
                                       'Content-Type': 'application/json'
                                    },
                                   // Specify the method
                                   method: 'POST',
                                   // A JSON payload
                                   body: JSON.stringify({"email":JSON.parse(atob(document.getElementById('email_data').value))['email']
                                   ,"joints_recorded":joint_static
                                })
                            }).then(function (response) { // At this point, Flask has printed our JSON
                            return response.text();
                            }).then(function (text) {
                            console.log('POST response: ');
                                    // Should be 'OK' if everything was successful
                                    var motion_data = JSON.parse(text);
                                    Motion_rec["Start_rec"] = motion_data["Start_rec"]

                         });

                 } 
    } 
   //}
    //This will not need to be run in the loop update according to the real angle loop will be running from th real-time sensor reading
    /*
    for (let i = 1; i <= 6; i++) {
        //Collect the joint setting animation input into here to run the nimation joint function in recorded motion control  
        const offset = i * Math.PI / 3;
        const ratio = Math.max(0, Math.sin(time + offset));
        viewer.setJointValue(`HY${ i }`, THREE.MathUtils.lerp(-4.2, 180, ratio) * DEG2RAD);   // Lerp is loop iteration boundary of the angle 
        viewer.setJointValue(`KP${ i }`, THREE.MathUtils.lerp(90, 150, ratio) * DEG2RAD);
        viewer.setJointValue(`AP${ i }`, THREE.MathUtils.lerp(-30, -60, ratio) * DEG2RAD);
        viewer.setJointValue(`TC${ i }A`, THREE.MathUtils.lerp(0, 0.065, ratio));
        viewer.setJointValue(`TC${ i }B`, THREE.MathUtils.lerp(0, 0.065, ratio));
        viewer.setJointValue(`W${ i }`, window.performance.now() * 0.0);
     
    
    }
    */
   //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
   
};

const updateLoop = () => {

    if (animToggle.classList.contains('checked')) {
        updateAngles();
    }

    requestAnimationFrame(updateLoop);

};

const updateList = () => {

    document.querySelectorAll('#urdf-options li[urdf]').forEach(el => {

        el.addEventListener('click', e => {

            const urdf = e.target.getAttribute('urdf');
            const color = e.target.getAttribute('color');

            viewer.up = '-Z';
            document.getElementById('up-select').value = viewer.up;
            viewer.urdf = urdf;
            animToggle.classList.add('checked');
            setColor(color);

        });

    });

};

updateList();

document.addEventListener('WebComponentsReady', () => {

    animToggle.addEventListener('click', () => animToggle.classList.toggle('checked'));

    // stop the animation if user tried to manipulate the model
    viewer.addEventListener('manipulate-start', e => animToggle.classList.remove('checked'));
    viewer.addEventListener('urdf-processed', e => updateAngles());
    updateLoop();
    viewer.camera.position.set(-5.5, 3.5, 5.5);

});


        </script>
         
    </body>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KGJLJB0CMY">
</script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KGJLJB0CMY');
</script>
</html>
